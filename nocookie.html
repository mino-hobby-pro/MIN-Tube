<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Realtime Game</title>
    <script type="module">
        // Firebaseの初期化
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYO7lc3tTKdNlK1wLjTTpneQL-zkYU3uA",
            authDomain: "chatapp-by-kbk.firebaseapp.com",
            databaseURL: "https://chatapp-by-kbk-default-rtdb.firebaseio.com",
            projectId: "chatapp-by-kbk",
            storageBucket: "chatapp-by-kbk.appspot.com",
            messagingSenderId: "254822225505",
            appId: "1:254822225505:web:1d8121702659a448fa7c20",
            measurementId: "G-ZPDHPNGVSN"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const playersCollection = collection(db, 'players');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const players = {};

        // プレイヤーの追加
        async function addPlayer(playerData) {
            try {
                const docRef = await addDoc(playersCollection, playerData);
                console.log("Player added with ID: ", docRef.id);
            } catch (e) {
                console.error("Error adding player: ", e);
            }
        }

        // プレイヤーの取得
        async function getPlayers() {
            const querySnapshot = await getDocs(playersCollection);
            querySnapshot.forEach((doc) => {
                players[doc.id] = doc.data();
            });
            drawPlayers();
        }

        // リアルタイムの監視
        onSnapshot(playersCollection, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                const playerData = change.doc.data();
                if (change.type === "added") {
                    players[change.doc.id] = playerData;
                }
                if (change.type === "modified") {
                    players[change.doc.id] = playerData;
                }
                if (change.type === "removed") {
                    delete players[change.doc.id];
                }
                drawPlayers();
            });
        });

        // プレイヤーの動きの更新
        async function updatePlayerPosition(playerId, newPosition) {
            const playerRef = doc(db, "players", playerId);
            await updateDoc(playerRef, {
                position: newPosition
            });
        }

        // プレイヤーを描画
        function drawPlayers() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (const playerId in players) {
                const player = players[playerId];
                ctx.fillStyle = 'blue';
                ctx.fillRect(player.position.x, player.position.y, 10, 10);
            }
        }

        // ゲームの初期化
        window.onload = async () => {
            // プレイヤーの初期データ
            const playerData = {
                position: { x: Math.random() * canvas.width, y: Math.random() * canvas.height }
            };
            await addPlayer(playerData);
            getPlayers();

            // プレイヤーの動きのシミュレーション（ランダムに動く）
            setInterval(() => {
                const playerId = Object.keys(players)[0]; // 最初のプレイヤーを動かす
                const newPosition = {
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height
                };
                updatePlayerPosition(playerId, newPosition);
            }, 1000);
        };
    </script>
</head>
<body>
    <canvas id="gameCanvas" width="800" height="600" style="border:1px solid #000000;"></canvas>
</body>
</html>
